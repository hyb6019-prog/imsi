<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org">
<head>
<meta charset="UTF-8">
<title>Insert title here</title>
<style>
	.notice-view-wrap{
		width:1200px;margin:0 auto;
	}
	.noticeContent{
		min-height:300px;
	}
</style>
</head>
<body>
	<th:block th:include="common/header"></th:block>
	<main class="content">
		<section class="section notice-view-wrap">
			<div class="page-title">공지사항</div>
			<table class="tbl">
				<tr>
					<th colspan="4" th:text="${n.noticeTitle}"></th>
				</tr>
				<tr>
					<th style="width:20%;">작성자</th>
					<td style="width:30%;" th:text="${n.noticeWriter}"></td>
					<th style="width:20%;">작성일</th>
					<td style="width:30%;" th:text="${n.regDate}"></td>
				</tr>
				<tr>
					<th>첨부파일</th>
					<td colspan="3">
						<th:block th:each="file : ${n.fileList}">
							<img src="/image/file.png" style="width:16px;">		
							<a th:href="@{/notice/filedown(noticeFileNo=${file.noticeFileNo})}" th:text="${file.filename}"></a>				
						</th:block>
					</td>
				</tr>
				<tr>
					<td class="left" colspan="4">
						<div class="noticeContent" th:utext="${n.noticeContentBr}"></div>
					</td>
				</tr>
				<tr th:if="${session.member != null && session.member.memberId == n.noticeWriter}">
					<td colspan="4">
						<a class="btn-primary" th:href="@{/notice/updateFrm(noticeNo=${n.noticeNo})}">수정</a>
						<button class="btn-secondary" th:onclick="deleteNotice([[${n.noticeNo}]])">삭제</button>
					</td>
				</tr>
			</table>
			<!-- 댓글입력 -->
			<div class="inputCommentBox" th:if="${session.member != null}">
				<form action="/notice/insertComment" method="post">
					<ul>
						<li>
							<span class="material-icons">account_box</span>
						</li>
						<li>
							<input type="hidden" name="noticeCommentWriter" th:value="${session.member.memberId}">
							<input type="hidden" name="noticeRef" th:value="${n.noticeNo}">
							<div class="input-item">
								<textarea name="noticeCommentContent"></textarea>
							</div>
						</li>
						<li>
							<button type="submit" class="btn-primary">등록</button>
						</li>
					</ul>
				</form>
			</div>
			<!-- 댓글 출력(위 아래 어디든 선택사항) -->
			<th:block th:each="nc : ${n.commentList}" th:if="${nc.noticeCommentRef == 0}">
				<ul class="posting-comment">
					<li>
						<span class="material-icons">account_box</span>
					</li>
					<li>
						<p class="comment-info">
							<span th:text="${nc.noticeCommentWriter}"></span>
							<span th:text="${nc.noticeCommentDate}"></span>
							<span class="like-box">
								<span th:if="${session.member != null}" class="material-icons" th:onclik="likepush([[${nc.noticeCommentNo}]],this)">thumb_up_off_alt</span>
								<span th:if="${session.member != null}" class="material-icons" th:onclik="loginMsg()">thumb_up_off_alt</span>
								
								<span>10</span>
							</span>
						</p>
						<p class="comment-content" th:text="${nc.noticeCommentContent}"></p>
						<div class="input-item" style="display:none;" th:if="${session.member != null && session.member.memberId == nc.noticeCommentWriter}">
							<textarea name="noticeCommentContent"></textarea>
						</div>
						<p class="comment-link">
							<!-- 로그인 여부 체크 -->
							<th:block th:if="${session.member != null}">
								<!-- 로그인한 회원이 댓글 작성자인지 체크 -->
								<th:block th:if="${session.member.memberId == nc.noticeCommentWriter}">
									<a th:onclick="modifyComment(this, [[${n.noticeNo}]], [[${nc.noticeCommentNo}]]);">수정</a>
									<a th:onclick="deleteComment([[${n.noticeNo}]], [[${nc.noticeCommentNo}]]);">삭제</a>
								</th:block>
								<a class="recShow">답글달기</a>
							</th:block>
						</p>
					</li>
				</ul>
				<!-- 대댓글 출력 -->
				<ul class="posting-comment reply" th:each="ncc : ${n.commentList}" th:if="${ncc.noticeCommentRef == nc.noticeCommentNo}">
					<li>
						<span class="material-icons">subdirectory_arrow_right</span>
						<span class="material-icons">account_box</span>
					</li>
					<li>
						<p class="comment-info">
							<span th:text="${ncc.noticeCommentWriter}"></span>
							<span th:text="${ncc.noticeCommentDate}"></span>
						</p>
						<p class="comment-content" th:text="${ncc.noticeCommentContent}"></p>
						<div class="input-item" style="display:none;" th:if="${session.member != null && session.member.memberId == ncc.noticeCommentWriter}">
							<textarea name="noticeCommentContent"></textarea>
						</div>
						<p class="comment-link">
							<th:block th:if="${session.member != null && session.member.memberId == ncc.noticeCommentWriter}">
								<a th:onclick="modifyComment(this, [[${n.noticeNo}]], [[${ncc.noticeCommentNo}]]);">수정</a>
								<a th:onclick="deleteComment([[${n.noticeNo}]], [[${ncc.noticeCommentNo}]]);">삭제</a>
							</th:block>
						</p>
					</li>
				</ul>
				
				<!-- 대댓글 작성 양식 -->
				<div class="inputCommentBox inputRecommentBox" th:if="${session.member != null}">
					<form action="/notice/insertComment" method="post">
						<ul>
							<li>
								<span class="material-icons">subdirectory_arrow_right</span>
							</li>
							<li>
								<input type="hidden" name="noticeCommentWriter" th:value="${session.member.memberId}">
								<input type="hidden" name="noticeRef" th:value="${n.noticeNo}">
								<input type="hidden" name="noticeCommentRef" th:value="${nc.noticeCommentNo}">
								<div class="input-item">
									<textarea name="noticeCommentContent"></textarea>
								</div>	
							</li>
							<li>
								<button type="submit" class="btn-primary">등록</button>
							</li>
						</ul>
					</form>
				</div>
			</th:block>
		</section>
	</main>
	<script src="/js/sweetalert.min.js"></script>
	<script>
		function deleteNotice(noticeNo){
			  swal({
			    title: "공지사항 삭제",
			    text: "게시글을 삭제하시겠습니까?",
			    icon: "warning",
			    buttons: {                
			      cancel: {
			        text: "취소",
			        value: false,
			        visible: true,
			        className: "btn-secondary",
			        closeModal: true
			      },
			      confirm: {
			        text: "삭제",
			        value: true,
			        visible: true,
			        className: "btn-primary",
			        closeModal: true
			      }
			    }
			  }).then(function(isConfirm){ 
			    if (isConfirm) {
			      location.href = "/notice/delete?noticeNo="+(noticeNo);
			    }
			  });
			}
		
		$(".recShow").on("click",function(){
			//화면에 있는 답글달기 버튼 중 몇번째 버튼을 눌렀는지
			const index = $(".recShow").index(this);
			if($(this).text() === "답글달기"){
				$(this).text("취소");
			}else{
				$(this).text("답글달기");
			}
			$(".inputRecommentBox").eq(index).toggle();
		});
		
		function modifyComment(obj, noticeNo, noticeCommentNo){
			  //화면에 출력되고 있는 현재 댓글 내용을 문자열로 가져옴
			  const noticeCommentContent = $(obj).parent().prev().prev().text();
			  //화면에 숨겨둔 textarea에 현재 댓글내용 입력
			  $(obj).parent().prev().children().text(noticeCommentContent);
			  //화면에 출력되고있는 현재 댓글 내용을 숨김
			  $(obj).parent().prev().prev().hide();
			  //화면에 숨겨둔 textarea를 감싼 div를 보여줌
			  $(obj).parent().prev().show();
			  
			  /////////////////////////////////////
			  //수정 -> 수정완료
			  $(obj).text("수정완료");
			  $(obj).attr("onclick", "modifyComplete(this,"+noticeNo+","+noticeCommentNo+")");
			  //삭제 -> 수정취소
			  $(obj).next().text("수정취소");
			  $(obj).next().attr("onclick", "modifyCancel(this, "+noticeNo+","+noticeCommentNo+")");
			  
			  //답글달기버튼이 있는경우 화면에서 안보이게 처리
			  $(obj).next().next().hide();
			}
		function modifyComplete(obj, noticeNo, noticeCommentNo){
			//form태그 생성해서 내부에 필요한 태그들을 작성해서 넣은 후 submit
			//1. form태그 생성
			const form = $("<form>");
			//1-1. form태그 속성 설정
			form.attr("action", "/notice/updateComment");//<form action="/notice/updateComment"></form>
			form.attr("method", "post")//<form action="/notice/updateComment" method="post"></form>
			form.hide();
			
			//2. form태그 내부에 전송하고 싶은 데이터를 input, textarea, select..등의 태그로 삽입
			const noticeCommentNoInput = $("<input>");//<input>
			noticeCommentNoInput.attr("type", "text");//<input type="text">
			noticeCommentNoInput.attr("name", "noticeCommentNo");//<input type="text" name="noticeCommentNo">
			noticeCommentNoInput.val(noticeCommentNo);
			
			const noticeRefInput = $("<input type='text' name='noticeRef'>");
			noticeRefInput.val(noticeNo);//<input type="text" name="noticeRef" value="?">
			
			//3. 수정된 댓글이 입력되어있는 textarea를 복사해서 가져옴 / 복사하지 않으면 그대로 잘라서 가져와서 기존 댓글에 텍스트가 안보임
			const noticeCommentContent = $(obj).parent().prev().children().clone();
			
			//4. form태그에 추가
			form.append(noticeCommentNoInput).append(noticeRefInput).append(noticeCommentContent);
			
			//5. form태그를 현재페이지에 추가
			$("body").append(form);
			
			//6. form태그 submit
			form.submit();
			
		}
		function modifyCancel(obj, noticeNo, noticeCommentNo){
			//화면에 보여지고 있는 textarea를 감싼 div를 다시 숨김
			$(obj).parent().prev().hide();
			//화면에 숨겨놨던 댓글 출력하는 p태그를 화면에 보여줌
			$(obj).parent().prev().prev().show();
			
			////////////////////////////////////////
			//수정완료 -> 수정
			$(obj).prev().text("수정");
			$(obj).prev().attr("onclick", "modifyComment(this,"+noticeNo+","+noticeCommentNo+");");
			//수정취소 -> 삭제
			$(obj).text("삭제");
			$(obj).attr("onclick", "deleteComment("+noticeNo+", "+noticeCommentNo+");");
			
			//답글달기버튼 화면에 보여줌
			$(obj).next().show();
		}
		function deleteComment(noticeNo, noticeCommentNo){
		  if(confirm("댓글을 삭제하시겠습니까?")){
			  location.href="/notice/deleteComment?noticeRef="+noticeNo+"&noticeCommentNo="+noticeCommentNo;
			  
		  }
		}
		
		function likepush(noticeCommentNo, obj){
			
		}
		function loginMsg(){
			alert("로그인 후 사용 가능합니다.");
		}
	</script>
	<th:block th:include="common/footer"></th:block>
</body>
</html>